<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <link href="styles/motif.css" rel="stylesheet" />
    <script type="text/javascript" src="src/motif.js"></script>
    <script type="text/javascript" src="src/motif_lexer.js"></script>
    <script type="text/javascript" src="src/motif_runtime.js"></script>
    <script type="text/javascript">

        var lexer, runtime;
        var opacity = .3;

        function placeCursor() {
            var oldcursors = document.getElementsByClassName("blinking-cursor");
            for (var i = oldcursors.length - 1; i >= 0; i--) {
                oldcursors[i].remove();
            }

            let currBlock = document.getElementById("main").lastChild;
            let cursor = document.createElement('span');
            cursor.setAttribute("class","blinking-cursor bblink");
            cursor.innerText = "\u2502";
            currBlock.appendChild(cursor);
        }


        // This simply adds a new div to main. If it is an odd numbered div, it will be content. If it is an even numbered div, it will be response from the lexer.
        // TODO: this should take an argument to make sure it's an error or not and actually check
        function writeCode(content, cursorMove = false, isNewLine = true) {
            document.getElementById("main");
            var newDiv = document.createElement("div");
            newDiv.innerText = content;
            if (!isNewLine) {
                main.removeChild(main.lastChild)
            }
            main.appendChild(newDiv);
            if (cursorMove) placeCursor();
        }

        function writeResponse(content, error = false) {
            document.getElementById("main");
            var newDiv = document.createElement("div");
            if (error) {
                newDiv.classList.add("error");
            }
            newDiv.innerText = content;
            main.appendChild(newDiv);
        }

        function updateStacks() {
            let stackbox = document.getElementById("stacks");
            let text = "";
            for(let i = 0; i < runtime.stacks.length; i++) {
                text += String.fromCharCode('A'.charCodeAt(0) + i) + " [";
                for(let j = 0; j < runtime.stacks[i].length; j++) {
                    if (j > 0) text += " ";
                    text += runtime.stacks[i][j];
                }
                text += "]<br/>";
            }
            stackbox.innerHTML = text;
        }

        function updateOutput(content) {

        }

        window.onload = function(e) {
            document.addEventListener('keypress', logKey);
            document.addEventListener('keydown', stopKeyProp)
            document.addEventListener('paste', readPastedCode)

            runtime = new motif.runtime(updateStacks, updateOutput);
            lexer = new motif.lexer(writeCode, writeResponse, runtime);

            writeCode("");
        };
        function stopKeyProp(e) {
            if (e.keyCode === 8) { // 8 = backspace
                e.preventDefault();
            }
        }
        function logKey(e) {
            lexer.readCharacter(e, "main");
            e.preventDefault();
        }
        function readPastedCode(e) {
            let paste = (e.clipboardData || window.clipboardData).getData('text');
            lexer.readTextBlock(paste, "main");
        }
    </script>
</head>
<body>
    <div id="cover_grad" class="cover"></div>
    <div id="cover_color" class="cover"></div>
    <div id="cover" class="cover"></div>
    <div id="stack_blocker"></div>
    <div id="stacks"></div>
    <div id="main"><div></div><div>motif repl console. enter command, or <a href="rules.html">learn the rules here</a></div></div>
</body>
</html>
